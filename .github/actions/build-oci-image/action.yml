name: 'Build OCI Extension Image'
description: 'Build and optionally push CloudNative-PG compatible OCI extension image for pglinter'

inputs:
  postgresql-version:
    description: 'PostgreSQL major version (e.g., 18)'
    required: true
    default: '18'

  distro:
    description: 'Linux distribution (e.g., bookworm for deb, el9 for rpm)'
    required: true
    default: 'bookworm'

  registry:
    description: 'Container registry (e.g., ghcr.io/pmpetit)'
    required: true
    default: 'ghcr.io/pmpetit'

  image-name:
    description: 'Image name (e.g., pglinter)'
    required: true
    default: 'pglinter'

  push:
    description: 'Whether to push the image to registry'
    required: false
    default: 'false'

  platforms:
    description: 'Target platforms for multi-arch build'
    required: false
    default: 'linux/amd64,linux/arm64'

  build-local:
    description: 'Whether to build locally (affects Dockerfile selection and build optimizations)'
    required: false
    default: 'false'

outputs:
  image-tags:
    description: 'Generated image tags'
    value: ${{ steps.build.outputs.image-tags }}

  image-digest:
    description: 'Image digest'
    value: ${{ steps.build.outputs.digest }}

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Prepare build context
      shell: bash
      run: |
        # Generate timestamp for tagging
        echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

        # Extract version from Cargo.toml
        PGLINTER_VERSION=$(grep '^version *= *' Cargo.toml | sed 's/^version *= *//' | tr -d '"' | tr -d ' ')
        echo "PGLINTER_VERSION=$PGLINTER_VERSION" >> $GITHUB_ENV

        # Determine package type and Dockerfile based on distro and build-local setting
        if [[ "${{ inputs.build-local }}" == "true" ]]; then
          # Use local Dockerfile for development/testing builds
          PKGTYPE="local"
          echo "DOCKERFILE=docker/oci/Dockerfile.local" >> $GITHUB_ENV
          echo "Using local Dockerfile for development build"
        else
          # Use distribution-specific Dockerfiles for production builds
          case "${{ inputs.distro }}" in
            bookworm|bullseye|buster|jammy|focal|noble)
              PKGTYPE="deb"
              echo "DOCKERFILE=docker/oci/Dockerfile.pg-deb" >> $GITHUB_ENV
              echo "Using Debian/Ubuntu Dockerfile for .deb packages (distro: ${{ inputs.distro }})"
              ;;
            el8|el9|fedora*|centos*|rocky*|alma*)
              PKGTYPE="rpm"
              echo "DOCKERFILE=docker/oci/Dockerfile.nodeb" >> $GITHUB_ENV
              echo "Using RPM-based Dockerfile for .rpm packages (distro: ${{ inputs.distro }})"
              ;;
            *)
              echo "âŒ Unsupported distro: ${{ inputs.distro }}"
              echo "Supported deb distros: bookworm, bullseye, buster, jammy, focal, noble"
              echo "Supported rpm distros: el8, el9, fedora*, centos*, rocky*, alma*"
              exit 1
              ;;
          esac
        fi

        echo "PKGTYPE=$PKGTYPE" >> $GITHUB_ENV

        # Set image tags
        BASE_TAG="$PGLINTER_VERSION-$PKGTYPE"
        FULL_TAG="$PGLINTER_VERSION-$(date +%Y%m%d%H%M%S)-pg${{ inputs.postgresql-version }}-${{ inputs.distro }}-$PKGTYPE"

        echo "BASE_TAG=$BASE_TAG" >> $GITHUB_ENV
        echo "FULL_TAG=$FULL_TAG" >> $GITHUB_ENV

    - name: Build and push OCI image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ env.DOCKERFILE }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        build-args: |
          PG_VERSION=${{ inputs.postgresql-version }}
          DISTRO=${{ inputs.distro }}
          PGLINTER_VERSION=${{ env.PGLINTER_VERSION }}
          TIMESTAMP=${{ env.TIMESTAMP }}
          EXT_VERSION=${{ env.PGLINTER_VERSION }}
        tags: |
          ${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.FULL_TAG }}
          ${{ inputs.registry }}/${{ inputs.image-name }}:latest
          ${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.BASE_TAG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Output image information
      shell: bash
      run: |
        echo "image-tags=${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.FULL_TAG }},${{ inputs.registry }}/${{ inputs.image-name }}:latest,${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.BASE_TAG }}" >> $GITHUB_OUTPUT
        echo "Built OCI image with tags:"
        echo "  - ${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.FULL_TAG }}"
        echo "  - ${{ inputs.registry }}/${{ inputs.image-name }}:latest"
        echo "  - ${{ inputs.registry }}/${{ inputs.image-name }}:${{ env.BASE_TAG }}"

# .github/actions/reusable-package-action/action.yml
name: 'Build package and upload'

description: 'Builds rpm/deb package and upload.'

inputs:
  pgver:
    description: 'The PostgreSQL major version without the "pg" prefix (e.g. `13`, `16`, etc.)'
    required: true
  tag:
    description: 'The pglinter version associated with the release.'
    required: true
    default: 'v0.0.0' # Set a default to handle cases where no tag is provided

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup workspace for postgres user
      run: |
        chown -R postgres:postgres $GITHUB_WORKSPACE
        chmod -R 755 $GITHUB_WORKSPACE
      shell: bash

    - name: Build packages
      run: |
        su - postgres -c "cd $GITHUB_WORKSPACE && make deb"
        su - postgres -c "cd $GITHUB_WORKSPACE && make rpm"
      shell: bash
      env:
        PGLINTER_MINOR_VERSION: ${{ input.tag }}
    - name: 'RPM package for $[[ inputs.pgver ]] (x64_64)'
      uses: actions/upload-artifact@v4
      with:
        name: 'pglinter-${{ inputs.pgver }}-pg${{ inputs.tag }}-${{ inputs.tag }}.rpm'
        path: |
          '$GITHUB_WORKSPACE/target/release/pglinter-pg${{ inputs.pgver }}/*.rpm'

    - name: 'DEB package for $[[ inputs.pgver ]] (x64_64)'
      uses: actions/upload-artifact@v4
      with:
        name: 'pglinter-${{ inputs.pgver }}-pg${{ inputs.tag }}-${{ inputs.tag }}.deb'
        path: |
          '$GITHUB_WORKSPACE/target/release/pglinter-pg${{ inputs.pgver }}/*.deb'

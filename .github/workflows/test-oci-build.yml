name: Test OCI Build

on:
  workflow_dispatch:
    inputs:
      postgresql_version:
        description: 'PostgreSQL version to test'
        required: false
        default: '18'
        type: choice
        options:
          - '16'
          - '17'
          - '18'
      push_to_registry:
        description: 'Push test image to registry'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: pglinter

jobs:
  test-build:
    name: Test OCI Build
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        if: inputs.push_to_registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build OCI image
        id: build
        uses: ./.github/actions/build-oci-image
        with:
          postgresql-version: ${{ inputs.postgresql_version }}
          registry: ${{ env.REGISTRY }}/${{ github.repository_owner }}
          image-name: ${{ env.IMAGE_NAME }}-test
          push: ${{ inputs.push_to_registry }}
          build-local: 'true'
          platforms: linux/amd64  # Single platform for faster testing

      - name: Test image locally
        run: |
          echo "Testing built image..."

          # Check if image exists
          docker images | grep pglinter-test || echo "No test image found"

          # Get image info
          if docker images | grep -q pglinter-test; then
            IMAGE_ID=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.ID}}" | grep pglinter-test | head -1 | awk '{print $2}')
            echo "Image ID: $IMAGE_ID"

            # Check image size
            SIZE=$(docker image inspect $IMAGE_ID --format '{{.Size}}')
            echo "Image size: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"

            # Check labels
            echo "Extension labels:"
            docker image inspect $IMAGE_ID --format '{{range $k, $v := .Config.Labels}}{{if or (hasPrefix $k "extension.") (hasPrefix $k "org.opencontainers.image.")}}{{$k}}: {{$v}}{{"\n"}}{{end}}{{end}}'

            # Image history
            echo "Image layers:"
            docker history $IMAGE_ID --format "table {{.CreatedBy}}\t{{.Size}}"
          fi

          echo "âœ… OCI image test completed"

      - name: Output results
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PostgreSQL Version**: ${{ inputs.postgresql_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Push to Registry**: ${{ inputs.push_to_registry }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Built Images**: ${{ steps.build.outputs.image-tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY

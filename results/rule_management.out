-- Test for pglinter rule management functionality
BEGIN;
DROP EXTENSION IF EXISTS pglinter CASCADE;
NOTICE:  extension "pglinter" does not exist, skipping
CREATE TABLE IF NOT EXISTS test_table_for_rules (
    id INT,
    name TEXT
);
CREATE EXTENSION IF NOT EXISTS pglinter;
-- Show initial rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex
NOTICE:  B005   ‚úÖ ON     UnsecuredPublicSchema
NOTICE:  B006   ‚úÖ ON     HowManyTablesWithUppercase
NOTICE:  C001   ‚úÖ ON     MaxConnectionsByWorkMemIsNotLargerThanMemory
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt
NOTICE:  T001   ‚úÖ ON     TableWithoutPrimaryKey
NOTICE:  T002   ‚úÖ ON     TableWithoutIndex
NOTICE:  T003   ‚úÖ ON     TableWithRedundantIndex
NOTICE:  T004   ‚úÖ ON     TableWithFkNotIndexed
NOTICE:  T005   ‚úÖ ON     TableWithPotentialMissingIdx
NOTICE:  T006   ‚úÖ ON     TableWithFkOutsideSchema
NOTICE:  T007   ‚úÖ ON     TableWithUnusedIndex
NOTICE:  T008   ‚úÖ ON     TableWithFkMismatch
NOTICE:  T009   ‚úÖ ON     TableWithRoleNotGranted
NOTICE:  T010   ‚úÖ ON     ReservedKeyWord
NOTICE:  T011   ‚úÖ ON     TableWithUppercase
NOTICE:  T012   ‚úÖ ON     TableWithSensibleColumn
NOTICE:  ============================================================
NOTICE:  üìä Summary: 22 enabled, 0 disabled
 show_rules
------------
 t
(1 row)

-- Test enabling and disabling a specific rule
SELECT pglinter.is_rule_enabled('B001') AS b001_initially_enabled;
 b001_initially_enabled
------------------------
 t
(1 row)

-- Disable B001 rule
SELECT pglinter.disable_rule('B001') AS b001_disabled;
NOTICE:  üî¥ Rule B001 has been disabled
 b001_disabled
---------------
 t
(1 row)

-- Check if it's disabled
SELECT pglinter.is_rule_enabled('B001') AS b001_after_disable;
 b001_after_disable
--------------------
 f
(1 row)

-- Run base check (should skip B001)
SELECT pglinter.perform_base_check();
NOTICE:  üîç pglinter found 2 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B004] WARNING: Found 1 potentially unused indexes
NOTICE:  ‚ùå [B005] ERROR: Public schema allows CREATE privilege for all users - security risk
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 1 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check
--------------------
 t
(1 row)

-- Re-enable B001 rule
SELECT pglinter.enable_rule('B001') AS b001_enabled;
NOTICE:  ‚úÖ Rule B001 has been enabled
 b001_enabled
--------------
 t
(1 row)

-- Check if it's enabled again
SELECT pglinter.is_rule_enabled('B001') AS b001_after_enable;
 b001_after_enable
-------------------
 t
(1 row)

-- Test with non-existent rule
SELECT pglinter.disable_rule('NONEXISTENT') AS nonexistent_disable;
WARNING:  ‚ö†Ô∏è  Rule NONEXISTENT not found
 nonexistent_disable
---------------------
 f
(1 row)

-- Show final rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex
NOTICE:  B005   ‚úÖ ON     UnsecuredPublicSchema
NOTICE:  B006   ‚úÖ ON     HowManyTablesWithUppercase
NOTICE:  C001   ‚úÖ ON     MaxConnectionsByWorkMemIsNotLargerThanMemory
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt
NOTICE:  T001   ‚úÖ ON     TableWithoutPrimaryKey
NOTICE:  T002   ‚úÖ ON     TableWithoutIndex
NOTICE:  T003   ‚úÖ ON     TableWithRedundantIndex
NOTICE:  T004   ‚úÖ ON     TableWithFkNotIndexed
NOTICE:  T005   ‚úÖ ON     TableWithPotentialMissingIdx
NOTICE:  T006   ‚úÖ ON     TableWithFkOutsideSchema
NOTICE:  T007   ‚úÖ ON     TableWithUnusedIndex
NOTICE:  T008   ‚úÖ ON     TableWithFkMismatch
NOTICE:  T009   ‚úÖ ON     TableWithRoleNotGranted
NOTICE:  T010   ‚úÖ ON     ReservedKeyWord
NOTICE:  T011   ‚úÖ ON     TableWithUppercase
NOTICE:  T012   ‚úÖ ON     TableWithSensibleColumn
NOTICE:  ============================================================
NOTICE:  üìä Summary: 22 enabled, 0 disabled
 show_rules
------------
 t
(1 row)

ROLLBACK;

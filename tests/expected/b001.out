-- Test for pglinter B001 rule with file output
CREATE EXTENSION pglinter;
CREATE TABLE my_table_without_pk (
    id INT,
    name TEXT,
    code TEXT,
    enable BOOL DEFAULT TRUE,
    query TEXT,
    warning_level INT,
    error_level INT,
    scope TEXT
);
-- Disable all rules first
SELECT pglinter.disable_all_rules() AS all_rules_disabled;
NOTICE:  ğŸ”´ Disabled 19 rule(s)
 all_rules_disabled 
--------------------
                 19
(1 row)

-- Run table check to detect tables without PK
SELECT pglinter.check();
NOTICE:  âœ… No issues found - database schema looks good!
 check 
-------
 t
(1 row)

-- Test rule management for B001
SELECT pglinter.explain_rule('B001');
NOTICE:  ğŸ“– Rule Explanation for B001
============================================================

ğŸ¯ Rule Name: HowManyTableWithoutPrimaryKey
ğŸ“‹ Scope: BASE

ğŸ“ Description:
Count number of tables without primary key.

âš ï¸  Message Template:
{0}/{1} table(s) without primary key exceed the {2} threshold: {3}%. Object list:\n{4}

ğŸ”§ How to Fix:
   1. create a primary key or change warning/error threshold
============================================================
 explain_rule 
--------------
 t
(1 row)

SELECT pglinter.is_rule_enabled('B001') AS is_b001_enabled;
 is_b001_enabled 
-----------------
 f
(1 row)

-- Test with file output
SELECT pglinter.check('/tmp/pglinter_base_results.sarif');
 check 
-------
 t
(1 row)

-- Test if file exists
\! md5sum /tmp/pglinter_base_results.sarif
7cd6073b52ee9a1173c05c016e2458f4  /tmp/pglinter_base_results.sarif
-- Re-enable B001 rule
SELECT pglinter.enable_rule('B001') AS enable_b001;
NOTICE:  âœ… Rule B001 has been enabled
 enable_b001 
-------------
 t
(1 row)

-- Test again with B001 enabled
SELECT pglinter.check();
NOTICE:  ğŸ” pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  âŒ [B001] ERROR: 1/1 table(s) without primary key exceed the error threshold: 100%. Object list:
public.my_table_without_pk

NOTICE:  ==================================================
NOTICE:  ğŸ“Š Summary: 1 error(s), 0 warning(s), 0 info
NOTICE:  ğŸ”´ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

-- Test with file output
SELECT pglinter.check('/tmp/pglinter_base_results.sarif');
 check 
-------
 t
(1 row)

-- Test if file exists
\! md5sum /tmp/pglinter_base_results.sarif
abcbc2dd1c791c3445280188aa4a9386  /tmp/pglinter_base_results.sarif
DROP TABLE my_table_without_pk CASCADE;
DROP EXTENSION pglinter CASCADE;

-- Simple example to demonstrate database-wide primary key analysis and B001 rule detection
-- This script creates multiple tables with and without primary keys to test the B001 percentage-based rule
CREATE EXTENSION pglinter;
-- Create tables WITHOUT primary keys to trigger B001 rule (need enough to exceed 20% threshold)
-- These tables will contribute to the "tables without primary key" count
CREATE TABLE orders_no_pk (
    order_id INTEGER NOT NULL,
    customer_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    order_date DATE NOT NULL DEFAULT CURRENT_DATE,
    quantity INTEGER DEFAULT 1,
    total_amount DECIMAL(10, 2),
    status VARCHAR(20) DEFAULT 'pending'
);
CREATE TABLE customers_no_pk (
    customer_id INTEGER NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    city VARCHAR(50),
    state VARCHAR(20),
    zip_code VARCHAR(10)
);
CREATE TABLE products_no_pk (
    product_id INTEGER NOT NULL,
    product_name VARCHAR(100) NOT NULL,
    description TEXT,
    category_id INTEGER,
    price DECIMAL(10, 2) NOT NULL,
    stock_quantity INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);
CREATE TABLE reviews_no_pk (
    review_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    customer_id INTEGER NOT NULL,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    review_text TEXT,
    review_date DATE DEFAULT CURRENT_DATE,
    helpful_votes INTEGER DEFAULT 0
);
CREATE TABLE inventory_no_pk (
    inventory_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    warehouse_location VARCHAR(50),
    quantity_on_hand INTEGER DEFAULT 0,
    quantity_reserved INTEGER DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE shipments_no_pk (
    shipment_id INTEGER NOT NULL,
    order_id INTEGER NOT NULL,
    tracking_number VARCHAR(100),
    carrier VARCHAR(50),
    shipped_date DATE,
    estimated_delivery DATE,
    actual_delivery DATE,
    shipment_status VARCHAR(20) DEFAULT 'pending'
);
CREATE TABLE payments_no_pk (
    payment_id INTEGER NOT NULL,
    order_id INTEGER NOT NULL,
    payment_method VARCHAR(20) NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    payment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    transaction_reference VARCHAR(100),
    payment_status VARCHAR(20) DEFAULT 'pending'
);
-- Create some tables WITH primary keys (these will NOT contribute to the problem)
CREATE TABLE categories_with_pk (
    id SERIAL PRIMARY KEY,
    category_name VARCHAR(50) NOT NULL,
    description TEXT,
    parent_category_id INTEGER,
    is_active BOOLEAN DEFAULT TRUE
);
CREATE TABLE users_with_pk (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
CREATE TABLE settings_with_pk (
    id SERIAL PRIMARY KEY,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE
);
-- Insert some test data to make tables more realistic
INSERT INTO orders_no_pk (order_id, customer_id, product_id, quantity, total_amount, status) VALUES
(1001, 1, 101, 2, 59.98, 'completed'),
(1002, 2, 102, 1, 29.99, 'pending'),
(1003, 1, 103, 3, 89.97, 'shipped');
INSERT INTO customers_no_pk (customer_id, first_name, last_name, email, phone) VALUES
(1, 'John', 'Doe', 'john.doe@example.com', '555-0101'),
(2, 'Jane', 'Smith', 'jane.smith@example.com', '555-0102'),
(3, 'Bob', 'Johnson', 'bob.johnson@example.com', '555-0103');
INSERT INTO products_no_pk (product_id, product_name, description, category_id, price, stock_quantity) VALUES
(101, 'Laptop Computer', 'High-performance laptop', 1, 899.99, 50),
(102, 'Wireless Mouse', 'Ergonomic wireless mouse', 2, 24.99, 100),
(103, 'Keyboard', 'Mechanical keyboard', 2, 79.99, 75);
INSERT INTO categories_with_pk (category_name, description) VALUES
('Electronics', 'Electronic devices and accessories'),
('Computers', 'Computer hardware and peripherals'),
('Office Supplies', 'General office equipment');
INSERT INTO users_with_pk (username, email, password_hash) VALUES
('admin', 'admin@example.com', 'hashed_password_1'),
('user1', 'user1@example.com', 'hashed_password_2'),
('user2', 'user2@example.com', 'hashed_password_3');
-- Update table statistics
ANALYZE orders_no_pk;
ANALYZE customers_no_pk;
ANALYZE products_no_pk;
ANALYZE reviews_no_pk;
ANALYZE inventory_no_pk;
ANALYZE shipments_no_pk;
ANALYZE payments_no_pk;
ANALYZE categories_with_pk;
ANALYZE users_with_pk;
ANALYZE settings_with_pk;
-- Test B001 rule
SELECT 'Testing B001 rule - Database-wide primary key percentage analysis...' AS test_info;
                              test_info                               
----------------------------------------------------------------------
 Testing B001 rule - Database-wide primary key percentage analysis...
(1 row)

-- First, disable all rules to isolate B001 testing
SELECT pglinter.disable_all_rules() AS all_rules_disabled;
NOTICE:  ðŸ”´ Disabled 20 rule(s)
 all_rules_disabled 
--------------------
                 20
(1 row)

-- Enable only B001 for focused testing
SELECT pglinter.enable_rule('B001') AS b001_enabled;
NOTICE:  âœ… Rule B001 has been enabled
 b001_enabled 
--------------
 t
(1 row)

-- Verify B001 is enabled
SELECT pglinter.is_rule_enabled('B001') AS b001_status;
 b001_status 
-------------
 t
(1 row)

-- Run base check to detect database-wide primary key percentage issues
SELECT 'Running base check to detect B001 violations...' AS status;
                     status                      
-------------------------------------------------
 Running base check to detect B001 violations...
(1 row)

SELECT pglinter.check();
NOTICE:  ðŸ” pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  âš ï¸  [B001] WARNING: 7/10 table(s) without primary key exceed the warning threshold: 70%. Object list:
public.orders_no_pk
public.customers_no_pk
public.products_no_pk
public.shipments_no_pk
public.reviews_no_pk
public.inventory_no_pk
public.payments_no_pk

NOTICE:  ==================================================
NOTICE:  ðŸ“Š Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  ðŸŸ¡ Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

-- Test rule management for B001
SELECT 'Testing B001 rule management...' AS test_section;
          test_section           
---------------------------------
 Testing B001 rule management...
(1 row)

-- Disable B001 temporarily
SELECT pglinter.disable_rule('B001') AS b001_disabled;
NOTICE:  ðŸ”´ Rule B001 has been disabled
 b001_disabled 
---------------
 t
(1 row)

SELECT pglinter.is_rule_enabled('B001') AS b001_status_after_disable;
 b001_status_after_disable 
---------------------------
 f
(1 row)

-- Run base check again (should skip B001)
SELECT 'Running base check with B001 disabled (should find no B001 violations)...' AS status;
                                  status                                   
---------------------------------------------------------------------------
 Running base check with B001 disabled (should find no B001 violations)...
(1 row)

SELECT pglinter.check();
NOTICE:  âœ… No issues found - database schema looks good!
 check 
-------
 t
(1 row)

-- Re-enable B001
SELECT pglinter.enable_rule('B001') AS b001_reenabled;
NOTICE:  âœ… Rule B001 has been enabled
 b001_reenabled 
----------------
 t
(1 row)

SELECT pglinter.is_rule_enabled('B001') AS b001_status_after_enable;
 b001_status_after_enable 
--------------------------
 t
(1 row)

-- Run base check again (should detect B001 violations)
SELECT 'Running base check with B001 re-enabled...' AS status;
                   status                   
--------------------------------------------
 Running base check with B001 re-enabled...
(1 row)

SELECT pglinter.check();
NOTICE:  ðŸ” pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  âš ï¸  [B001] WARNING: 7/10 table(s) without primary key exceed the warning threshold: 70%. Object list:
public.orders_no_pk
public.customers_no_pk
public.products_no_pk
public.shipments_no_pk
public.reviews_no_pk
public.inventory_no_pk
public.payments_no_pk

NOTICE:  ==================================================
NOTICE:  ðŸ“Š Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  ðŸŸ¡ Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'B001';
 violation_count 
-----------------
               7
(1 row)

-- Now let's fix some of the issues by adding primary keys to reduce the percentage
SELECT 'Adding primary keys to some tables to improve the percentage...' AS improvement_info;
                        improvement_info                         
-----------------------------------------------------------------
 Adding primary keys to some tables to improve the percentage...
(1 row)

-- Add primary keys to reduce the percentage below the 20% threshold
ALTER TABLE orders_no_pk ADD CONSTRAINT pk_orders PRIMARY KEY (order_id);
ALTER TABLE customers_no_pk ADD CONSTRAINT pk_customers PRIMARY KEY (customer_id);
ALTER TABLE products_no_pk ADD CONSTRAINT pk_products PRIMARY KEY (product_id);
ALTER TABLE reviews_no_pk ADD CONSTRAINT pk_reviews PRIMARY KEY (review_id);
ALTER TABLE inventory_no_pk ADD CONSTRAINT pk_inventory PRIMARY KEY (inventory_id);
-- Keep 2 tables without primary keys to maintain some violations but below threshold
-- shipments_no_pk and payments_no_pk will remain without primary keys
-- Run B001 check again (should show reduced violations or no violations)
SELECT 'Running B001 check after adding primary keys (should show improved percentage):' AS test_info;
                                    test_info                                    
---------------------------------------------------------------------------------
 Running B001 check after adding primary keys (should show improved percentage):
(1 row)

SELECT pglinter.check();
NOTICE:  ðŸ” pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  âš ï¸  [B001] WARNING: 2/10 table(s) without primary key exceed the warning threshold: 20%. Object list:
public.shipments_no_pk
public.payments_no_pk

NOTICE:  ==================================================
NOTICE:  ðŸ“Š Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  ðŸŸ¡ Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

SELECT pglinter.check('/tmp/pglinter_b001_results.sarif');
 check 
-------
 t
(1 row)

\! md5sum /tmp/pglinter_b001_results.sarif
95b1aa589beea8fdb13fd0a66ea90518  /tmp/pglinter_b001_results.sarif
SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'B001';
 violation_count 
-----------------
               2
(1 row)

DROP TABLE orders_no_pk CASCADE;
DROP TABLE customers_no_pk CASCADE;
DROP TABLE products_no_pk CASCADE;
DROP TABLE reviews_no_pk CASCADE;
DROP TABLE inventory_no_pk CASCADE;
DROP TABLE shipments_no_pk CASCADE;
DROP TABLE payments_no_pk CASCADE;
DROP TABLE categories_with_pk CASCADE;
DROP TABLE users_with_pk CASCADE;
DROP TABLE settings_with_pk CASCADE;
DROP EXTENSION pglinter CASCADE;

-- Test for pglinter B002 rule: Redundant indexes
CREATE EXTENSION pglinter;
-- Create test tables with redundant indexes
CREATE TABLE test_table_with_redundant_indexes (
    id INT PRIMARY KEY,
    name TEXT,
    email VARCHAR(255),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW()
);
-- Create table with one index and a unique constrainte on the same column
CREATE TABLE orders_table_with_constraint (
    order_id SERIAL PRIMARY KEY,
    customer_id INT UNIQUE,
    product_name VARCHAR(255),
    order_date DATE,
    amount DECIMAL(10, 2)
);
-- Create an index that is redundant with the unique constraint
CREATE INDEX my_idx_customer ON orders_table_with_constraint (customer_id);
-- Create another table for more redundant index scenarios
CREATE TABLE orders_table (
    order_id SERIAL PRIMARY KEY,
    customer_id INT,
    product_name VARCHAR(255),
    order_date DATE,
    amount DECIMAL(10, 2)
);
-- Create redundant indexes to trigger B002 rule
-- Case 1: Exact duplicate indexes on same columns
CREATE INDEX idx_name_1 ON test_table_with_redundant_indexes (name);
CREATE INDEX idx_name_2 ON test_table_with_redundant_indexes (name, created_at);
CREATE INDEX idx_name_3 ON test_table_with_redundant_indexes (
    name, created_at, email
);
-- Case 2: Multiple indexes on same composite key
CREATE INDEX idx_email_status_1 ON test_table_with_redundant_indexes (
    email, status
);
CREATE INDEX idx_email_status_2 ON test_table_with_redundant_indexes (
    email, status, created_at
);
-- Case 3: Redundant indexes on the orders table
CREATE INDEX idx_customer_1 ON orders_table (order_id);
-- Case 3-bis: Non Redundant indexes on the orders table
CREATE INDEX idx_customer_2 ON orders_table (customer_id, order_id);
-- Case 4: Composite index redundancy
CREATE INDEX idx_customer_date_1 ON orders_table (product_name, order_date);
CREATE INDEX idx_customer_date_2 ON orders_table (product_name, order_date);
-- First, disable all rules to isolate B001 testing
SELECT pglinter.disable_all_rules() AS all_rules_disabled;
NOTICE:  üî¥ Disabled 19 rule(s)
 all_rules_disabled 
--------------------
                 19
(1 row)

-- Enable only B002 for focused testing
SELECT pglinter.enable_rule('B002') AS b001_enabled;
NOTICE:  ‚úÖ Rule B002 has been enabled
 b001_enabled 
--------------
 t
(1 row)

-- Test with file output
SELECT pglinter.perform_base_check('/tmp/pglinter_b002_results.sarif');
 perform_base_check 
--------------------
 t
(1 row)

-- Test if file exists and show checksum
\! md5sum /tmp/pglinter_b002_results.sarif
d33fa0746f8eacf2f90c32f1a9957845  /tmp/pglinter_b002_results.sarif
-- Test with no output file (should output to prompt)
SELECT pglinter.perform_base_check();
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 6/14 redundant(s) index exceed the warning threshold: 42%. Object list:
public.orders_table.idx_customer_date_2(product_name,order_date) is redundant with idx_customer_date_1(product_name,order_date)
public.orders_table.orders_table_pkey(order_id) is redundant with idx_customer_1(order_id)
public.orders_table.idx_customer_date_1(product_name,order_date) is redundant with idx_customer_date_2(product_name,order_date)
public.orders_table.idx_customer_1(order_id) is redundant with orders_table_pkey(order_id)
public.orders_table_with_constraint.my_idx_customer(customer_id) is redundant with orders_table_with_constraint_customer_id_key(customer_id)
public.orders_table_with_constraint.orders_table_with_constraint_customer_id_key(customer_id) is redundant with my_idx_customer(customer_id)
public.test_table_with_redundant_indexes.idx_name_1(name) is redundant with idx_name_3(name,created_at,email)
public.test_table_with_redundant_indexes.idx_email_status_1(email,status) is redundant with idx_email_status_2(email,status,created_at)
public.test_table_with_redundant_indexes.idx_name_2(name,created_at) is redundant with idx_name_3(name,created_at,email)
public.test_table_with_redundant_indexes.idx_name_1(name) is redundant with idx_name_2(name,created_at)

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 perform_base_check 
--------------------
 t
(1 row)

-- Test rule management for B002
SELECT pglinter.explain_rule('B002');
NOTICE:  üìñ Rule Explanation for B002
============================================================

üéØ Rule Name: HowManyRedudantIndex
üìã Scope: BASE

üìù Description:
Count number of redundant index vs nb index.

‚ö†Ô∏è  Message Template:
{0}/{1} redundant(s) index exceed the {2} threshold: {3}%. Object list:\n{4}

üîß How to Fix:
   1. remove duplicated index or check if a constraint does not create a redundant index, or change warning/error threshold
============================================================
 explain_rule 
--------------
 t
(1 row)

-- Show that B002 is enabled
SELECT pglinter.is_rule_enabled('B002') AS b002_enabled;
 b002_enabled 
--------------
 t
(1 row)

-- Disable B002 temporarily and test
SELECT pglinter.disable_rule('B002') AS b002_disabled;
NOTICE:  üî¥ Rule B002 has been disabled
 b002_disabled 
---------------
 t
(1 row)

SELECT pglinter.perform_base_check();
NOTICE:  ‚úÖ No issues found - database schema looks good!
 perform_base_check 
--------------------
 t
(1 row)

DROP TABLE orders_table CASCADE;
DROP TABLE orders_table_with_constraint CASCADE;
DROP TABLE test_table_with_redundant_indexes CASCADE;
DROP EXTENSION pglinter CASCADE;

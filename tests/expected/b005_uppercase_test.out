-- Test for pglinter B005 rule: Database objects with uppercase names
-- This script creates various database objects with uppercase names to test
-- the comprehensive B005 rule detection across all PostgreSQL object types
CREATE EXTENSION pglinter;
-- Create a test schema for our objects
CREATE SCHEMA test_B005_schema;
-- Create test objects with UPPERCASE names (should trigger B005)
-- Using quoted identifiers to force case-sensitive storage
-- 1. Table with uppercase name (quoted for case sensitivity)
CREATE TABLE test_B005_schema."CUSTOMERS_TABLE" (
    customer_id SERIAL PRIMARY KEY,
    "FIRST_NAME" VARCHAR(50),  -- Column with uppercase (quoted)
    last_name VARCHAR(50),     -- Column with lowercase (unquoted - should not trigger)
    "EMAIL_ADDRESS" VARCHAR(100), -- Column with uppercase (quoted)
    phone_number VARCHAR(20)   -- Column with lowercase (unquoted)
);
-- 2. View with uppercase name (quoted for case sensitivity)
CREATE VIEW test_B005_schema."ACTIVE_CUSTOMERS" AS
SELECT
    customer_id,
    "FIRST_NAME",
    last_name
FROM test_B005_schema."CUSTOMERS_TABLE"
WHERE customer_id > 0;
-- 3. Index with uppercase name (quoted for case sensitivity)
CREATE INDEX "IDX_CUSTOMERS_EMAIL" ON test_B005_schema."CUSTOMERS_TABLE" ("EMAIL_ADDRESS");
CREATE INDEX idx_customers_phone ON test_B005_schema."CUSTOMERS_TABLE" (phone_number); -- lowercase, should not trigger
-- 4. Sequence with uppercase name (quoted for case sensitivity)
CREATE SEQUENCE test_B005_schema."CUSTOMER_ID_SEQ";
-- 5. Function with uppercase name (quoted for case sensitivity)
CREATE OR REPLACE FUNCTION test_B005_schema."GET_CUSTOMER_COUNT"()
RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM test_B005_schema."CUSTOMERS_TABLE");
END;
$$ LANGUAGE plpgsql;
-- 6. Function with lowercase name (should not trigger)
CREATE OR REPLACE FUNCTION test_B005_schema.get_customer_by_id(p_id INTEGER)
RETURNS TEXT AS $$
BEGIN
    RETURN (SELECT "FIRST_NAME" FROM test_B005_schema."CUSTOMERS_TABLE" WHERE customer_id = p_id);
END;
$$ LANGUAGE plpgsql;
-- 7. Trigger with uppercase name
CREATE OR REPLACE FUNCTION test_B005_schema.update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
-- Add timestamp column for trigger
ALTER TABLE test_B005_schema."CUSTOMERS_TABLE" ADD COLUMN updated_at TIMESTAMP DEFAULT NOW();
CREATE TRIGGER "UPDATE_TIMESTAMP_TRIGGER"
BEFORE UPDATE ON test_B005_schema."CUSTOMERS_TABLE"
FOR EACH ROW EXECUTE FUNCTION test_B005_schema.update_timestamp();
-- 8. Constraint with uppercase name (user-defined, not auto-generated)
ALTER TABLE test_B005_schema."CUSTOMERS_TABLE"
ADD CONSTRAINT "EMAIL_UNIQUE_CONSTRAINT" UNIQUE ("EMAIL_ADDRESS");
-- 9. User-defined type with uppercase name
CREATE TYPE test_B005_schema."CUSTOMER_STATUS" AS ENUM ('active', 'inactive', 'pending');
-- 10. Domain with uppercase name
CREATE DOMAIN test_B005_schema."EMAIL_DOMAIN" AS VARCHAR(100)
CHECK (value ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
-- 11. Create another schema with uppercase name
CREATE SCHEMA "TEST_UPPERCASE_SCHEMA";
-- Create some data for testing
INSERT INTO test_B005_schema."CUSTOMERS_TABLE" ("FIRST_NAME", last_name, "EMAIL_ADDRESS", phone_number) VALUES
('John', 'Doe', 'john.doe@example.com', '555-1234'),
('Jane', 'Smith', 'jane.smith@example.com', '555-5678'),
('Bob', 'Johnson', 'bob.johnson@example.com', '555-9012');
-- Test B005 rule
SELECT 'Testing B005 rule - Comprehensive uppercase object detection...' AS test_info;
                            test_info                            
-----------------------------------------------------------------
 Testing B005 rule - Comprehensive uppercase object detection...
(1 row)

-- First, disable all rules to isolate B005 testing
SELECT pglinter.disable_all_rules() AS all_rules_disabled;
NOTICE:  üî¥ Disabled 20 rule(s)
 all_rules_disabled 
--------------------
                 20
(1 row)

-- Enable only B005 for focused testing
SELECT pglinter.enable_rule('B005') AS B005_enabled;
NOTICE:  ‚úÖ Rule B005 has been enabled
 b005_enabled 
--------------
 t
(1 row)

-- Verify B005 is enabled
SELECT pglinter.is_rule_enabled('B005') AS B005_status;
 b005_status 
-------------
 t
(1 row)

-- Run B005 check to detect uppercase violations
-- Expected result: Should detect multiple uppercase objects we created
SELECT 'Running B005 check to detect comprehensive uppercase violations...' AS status;
                               status                               
--------------------------------------------------------------------
 Running B005 check to detect comprehensive uppercase violations...
(1 row)

SELECT pglinter.check();
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 14/26 object(s) using uppercase for name or columns exceed the warning threshold: 53%. Object list:
column test_b005_schema.ACTIVE_CUSTOMERS.FIRST_NAME
column test_b005_schema.CUSTOMERS_TABLE.EMAIL_ADDRESS
column test_b005_schema.CUSTOMERS_TABLE.FIRST_NAME
function test_b005_schema.GET_CUSTOMER_COUNT
index test_b005_schema.CUSTOMERS_TABLE_pkey
index test_b005_schema.EMAIL_UNIQUE_CONSTRAINT
index test_b005_schema.IDX_CUSTOMERS_EMAIL
schema TEST_UPPERCASE_SCHEMA.TEST_UPPERCASE_SCHEMA
sequence test_b005_schema.CUSTOMERS_TABLE_customer_id_seq
sequence test_b005_schema.CUSTOMER_ID_SEQ
table test_b005_schema.ACTIVE_CUSTOMERS
table test_b005_schema.CUSTOMERS_TABLE
trigger test_b005_schema.UPDATE_TIMESTAMP_TRIGGER
view test_b005_schema.ACTIVE_CUSTOMERS

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

-- Test with file output
SELECT pglinter.check('/tmp/pglinter_B005_results.sarif');
 check 
-------
 t
(1 row)

-- Test if file exists and show checksum
\! md5sum /tmp/pglinter_B005_results.sarif
0058cc014457de4b5de5193b98b63faf  /tmp/pglinter_B005_results.sarif
-- Test rule management for B005
SELECT 'Testing B005 rule management...' AS test_section;
          test_section           
---------------------------------
 Testing B005 rule management...
(1 row)

SELECT pglinter.explain_rule('B005');
NOTICE:  üìñ Rule Explanation for B005
============================================================

üéØ Rule Name: HowManyObjectsWithUppercase
üìã Scope: BASE

üìù Description:
Count number of objects with uppercase in name or in columns.

‚ö†Ô∏è  Message Template:
{0}/{1} object(s) using uppercase for name or columns exceed the {2} threshold: {3}%. Object list:\n{4}

üîß How to Fix:
   1. Do not use uppercase for any database objects
============================================================
 explain_rule 
--------------
 t
(1 row)

DROP SCHEMA test_B005_schema CASCADE;
NOTICE:  drop cascades to 8 other objects
DETAIL:  drop cascades to table test_b005_schema."CUSTOMERS_TABLE"
drop cascades to view test_b005_schema."ACTIVE_CUSTOMERS"
drop cascades to sequence test_b005_schema."CUSTOMER_ID_SEQ"
drop cascades to function test_b005_schema."GET_CUSTOMER_COUNT"()
drop cascades to function test_b005_schema.get_customer_by_id(integer)
drop cascades to function test_b005_schema.update_timestamp()
drop cascades to type test_b005_schema."CUSTOMER_STATUS"
drop cascades to type test_b005_schema."EMAIL_DOMAIN"
DROP SCHEMA "TEST_UPPERCASE_SCHEMA" CASCADE;
DROP EXTENSION pglinter CASCADE;

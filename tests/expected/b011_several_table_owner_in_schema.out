-- Regression test for B011: SeveralTableOwnerInSchema
-- This test creates two tables in the same schema with different owners
-- and checks that the rule B011 correctly identifies the schema as problematic.
CREATE EXTENSION pglinter;
\pset pager off
-- Setup: Create test roles and schema
CREATE ROLE s005_owner1 LOGIN;
CREATE ROLE s005_owner2 LOGIN;
CREATE SCHEMA s005_schema AUTHORIZATION s005_owner1;
-- Create tables with different owners in the same schema
CREATE TABLE s005_schema.table1 (id INT);
ALTER TABLE s005_schema.table1 OWNER TO s005_owner1;
CREATE TABLE s005_schema.table2 (id INT);
ALTER TABLE s005_schema.table2 OWNER TO s005_owner2;
SELECT 'Testing B011 in isolation...' AS test_step;
          test_step           
------------------------------
 Testing B011 in isolation...
(1 row)

SELECT pglinter.disable_all_rules() AS all_disabled;
NOTICE:  üî¥ Disabled 19 rule(s)
 all_disabled 
--------------
           19
(1 row)

SELECT pglinter.enable_rule('B011') AS B011_only_enabled;
NOTICE:  ‚úÖ Rule B011 has been enabled
 b011_only_enabled 
-------------------
 t
(1 row)

SELECT pglinter.check(); -- Should only run B011
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B011] WARNING: 1/2 schemas have tables owned by different owners. Exceed the warning threshold: 50%. Object list:
s005_schema.table1 owner is s005_owner1
s005_schema.table2 owner is s005_owner2

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

-- Cleanup
DROP TABLE s005_schema.table1;
DROP TABLE s005_schema.table2;
DROP SCHEMA s005_schema;
DROP ROLE s005_owner1;
DROP ROLE s005_owner2;
DROP EXTENSION pglinter;

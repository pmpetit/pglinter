-- Comprehensive integration test for pglinter
-- Tests multiple rules across all categories (B, C, T, S series)
CREATE EXTENSION pglinter;
-- Create various test scenarios to trigger multiple rules
-- 1. Tables without primary keys (B001, T001)
CREATE TABLE users_no_pk (
    id INT,
    username TEXT,
    email TEXT
);
-- 2. Redundant indexes (B002, T003)
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    category TEXT,
    price NUMERIC
);
CREATE INDEX idx_name_1 ON products (name);
CREATE INDEX idx_name_2 ON products (name); -- redundant
CREATE INDEX idx_composite_1 ON products (category, price);
CREATE INDEX idx_composite_2 ON products (category, price); -- redundant
-- 3. Foreign keys without indexes (B003, T004)
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT,
    product_id INT,
    total NUMERIC
);
-- Add foreign keys without creating indexes
ALTER TABLE orders ADD CONSTRAINT fk_user
FOREIGN KEY (user_id) REFERENCES users_no_pk (id);
ERROR:  there is no unique constraint matching given keys for referenced table "users_no_pk"
ALTER TABLE orders ADD CONSTRAINT fk_product
FOREIGN KEY (product_id) REFERENCES products (id);
-- 4. Tables with uppercase names/columns (B006, T011)
CREATE TABLE "UPPERCASE_ISSUES" (
    id SERIAL PRIMARY KEY,
    "UPPER_NAME" TEXT,
    "DESCRIPTION" TEXT
);
-- 5. Reserved keywords (T010)
CREATE TABLE items (
    id SERIAL PRIMARY KEY,
    "SELECT" TEXT, -- reserved keyword
    "FROM" TEXT,   -- reserved keyword
    description TEXT
);
-- 6. Environment-prefixed schemas (S002)
CREATE SCHEMA prod_analytics;
CREATE SCHEMA dev_reports;
CREATE SCHEMA staging_data;
-- Add some tables to the schemas
CREATE TABLE prod_analytics.metrics (
    id SERIAL PRIMARY KEY,
    metric_name TEXT
);
CREATE TABLE dev_reports.summaries (
    id SERIAL PRIMARY KEY,
    report_data TEXT
);
-- Create extension
-- Run comprehensive analysis
SELECT '=== COMPREHENSIVE pglinter ANALYSIS ===' AS info;
                  info                   
-----------------------------------------
 === COMPREHENSIVE pglinter ANALYSIS ===
(1 row)

-- Test all rule categories
SELECT 'RULES:' AS category;
 category 
----------
 RULES:
(1 row)

SELECT pglinter.check();
NOTICE:  üîç pglinter found 12 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/7 table(s) without primary key exceed the warning threshold: 14%. Object list:
public.users_no_pk

NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 4/10 redundant(s) index exceed the warning threshold: 40%. Object list:
public.products.idx_name_1(name) is redundant with idx_name_2(name)
public.products.idx_name_2(name) is redundant with idx_name_1(name)
public.products.idx_composite_1(category,price) is redundant with idx_composite_2(category,price)
public.products.idx_composite_2(category,price) is redundant with idx_composite_1(category,price)

NOTICE:  ‚ùå [B003] ERROR: 1/1 table(s) without index on foreign key exceed the error threshold: 100%. Object list:
public.orders.fk_product

NOTICE:  ‚ùå [B004] ERROR: 4/4 unused index exceed the error threshold: 100%. Object list:
dev_reports.summarieshas100 % of seq scan.
prod_analytics.metricshas100 % of seq scan.
public.UPPERCASE_ISSUEShas100 % of seq scan.
public.itemshas100 % of seq scan.
public.ordershas100 % of seq scan.
public.productshas100 % of seq scan.
public.users_no_pkhas100 % of seq scan.

NOTICE:  ‚ö†Ô∏è  [B010] WARNING: 2/7 object(s) using reserved keywords exceed the warning threshold: 28%. Object list:
column in public.items.FROM is a reserved keyword: FROM
column in public.items.SELECT is a reserved keyword: SELECT

NOTICE:  ‚ö†Ô∏è  [C001] WARNING: CLUSTER {0} entries in pg_hba.conf with trust authentication method exceed the warning threshold: {1}. 1 : 
Row 1 

NOTICE:  ‚ùå [C002] ERROR: 6 entries in pg_hba.conf with trust or password authentication method exceed the warning threshold: 6.
NOTICE:  ‚ö†Ô∏è  [C003] WARNING: CLUSTER Encrypted passwords with MD5. 1 : 
password_encryption is md5 

NOTICE:  ‚ùå [S001] ERROR: No default role grantee on schema 5.5. It means that each time a table is created, you must grant it to roles. Object list:
dev_reports
prod_analytics
public
staging_data
tests

NOTICE:  ‚ùå [S002] ERROR: 3/5 schemas are prefixed or suffixed with environment names. It exceed the error threshold: 60%. Prefer prefix or suffix the database name instead. Object list:
dev_reports
prod_analytics
staging_data

NOTICE:  ‚ö†Ô∏è  [S003] WARNING: 1/5 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 20%. Object list:
public

NOTICE:  ‚ö†Ô∏è  [S004] WARNING: 1/5 schemas are owned by internal roles or superuser. Exceed the warning threshold: 20%. Object list:
mac-Z50PPETI is the owner of the schema dev_reports
mac-Z50PPETI is the owner of the schema prod_analytics
mac-Z50PPETI is the owner of the schema public
mac-Z50PPETI is the owner of the schema staging_data
mac-Z50PPETI is the owner of the schema tests

NOTICE:  ==================================================
NOTICE:  üìä Summary: 5 error(s), 7 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

-- Test rule management features
SELECT '=== RULE MANAGEMENT ===' AS info;
          info           
-------------------------
 === RULE MANAGEMENT ===
(1 row)

-- Show all rules
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B006   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B007   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkMismatch             
NOTICE:  B009   ‚úÖ ON     HowManyTablesWithSameTrigger            
NOTICE:  B010   ‚úÖ ON     HowManyTablesWithReservedKeywords       
NOTICE:  B011   ‚úÖ ON     SeveralTableOwnerInSchema               
NOTICE:  C001   ‚úÖ ON     PgHbaEntriesWithMethodTrustShouldNotExists
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  C003   ‚úÖ ON     PasswordEncryptionIsMd5                 
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  S003   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  S004   ‚úÖ ON     OwnerSchemaIsInternalRole               
NOTICE:  S005   ‚úÖ ON     SchemaOwnerDoNotMatchTableOwner         
NOTICE:  ============================================================
NOTICE:  üìä Summary: 19 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

-- Test some explanations
SELECT pglinter.explain_rule('B001');
NOTICE:  üìñ Rule Explanation for B001
============================================================

üéØ Rule Name: HowManyTableWithoutPrimaryKey
üìã Scope: BASE

üìù Description:
Count number of tables without primary key.

‚ö†Ô∏è  Message Template:
{0}/{1} table(s) without primary key exceed the {2} threshold: {3}%. Object list:\n{4}

üîß How to Fix:
   1. create a primary key or change warning/error threshold
============================================================
 explain_rule 
--------------
 t
(1 row)

SELECT pglinter.explain_rule('S002');
NOTICE:  üìñ Rule Explanation for S002
============================================================

üéØ Rule Name: SchemaPrefixedOrSuffixedWithEnvt
üìã Scope: SCHEMA

üìù Description:
The schema is prefixed with one of staging,stg,preprod,prod,sandbox,sbox string. Means that when you refresh your preprod, staging environments from production, you have to rename the target schema from prod_ to stg_ or something like. It is possible, but it is never easy.

‚ö†Ô∏è  Message Template:
{0}/{1} schemas are prefixed or suffixed with environment names. It exceed the {2} threshold: {3}%. Prefer prefix or suffix the database name instead. Object list:\n{4}

üîß How to Fix:
   1. Keep the same schema name across environments. Prefer prefix or suffix the database name
============================================================
 explain_rule 
--------------
 t
(1 row)

-- Test output to file functionality
SELECT '=== OUTPUT TO FILE TEST ===' AS info;
            info             
-----------------------------
 === OUTPUT TO FILE TEST ===
(1 row)

SELECT pglinter.check('/tmp/integration_base.sarif');
 check 
-------
 t
(1 row)

-- Test rule disable/enable functionality
SELECT '=== RULE TOGGLE TEST ===' AS info;
           info           
--------------------------
 === RULE TOGGLE TEST ===
(1 row)

-- Disable some rules
SELECT pglinter.disable_rule('B001');
NOTICE:  üî¥ Rule B001 has been disabled
 disable_rule 
--------------
 t
(1 row)

-- Run checks (should skip disabled rules)
SELECT pglinter.check();
NOTICE:  üîç pglinter found 11 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 4/10 redundant(s) index exceed the warning threshold: 40%. Object list:
public.products.idx_name_1(name) is redundant with idx_name_2(name)
public.products.idx_name_2(name) is redundant with idx_name_1(name)
public.products.idx_composite_1(category,price) is redundant with idx_composite_2(category,price)
public.products.idx_composite_2(category,price) is redundant with idx_composite_1(category,price)

NOTICE:  ‚ùå [B003] ERROR: 1/1 table(s) without index on foreign key exceed the error threshold: 100%. Object list:
public.orders.fk_product

NOTICE:  ‚ùå [B004] ERROR: 4/4 unused index exceed the error threshold: 100%. Object list:
dev_reports.summarieshas100 % of seq scan.
prod_analytics.metricshas100 % of seq scan.
public.UPPERCASE_ISSUEShas100 % of seq scan.
public.itemshas100 % of seq scan.
public.ordershas100 % of seq scan.
public.productshas100 % of seq scan.
public.users_no_pkhas100 % of seq scan.

NOTICE:  ‚ö†Ô∏è  [B010] WARNING: 2/7 object(s) using reserved keywords exceed the warning threshold: 28%. Object list:
column in public.items.FROM is a reserved keyword: FROM
column in public.items.SELECT is a reserved keyword: SELECT

NOTICE:  ‚ö†Ô∏è  [C001] WARNING: CLUSTER {0} entries in pg_hba.conf with trust authentication method exceed the warning threshold: {1}. 1 : 
Row 1 

NOTICE:  ‚ùå [C002] ERROR: 6 entries in pg_hba.conf with trust or password authentication method exceed the warning threshold: 6.
NOTICE:  ‚ö†Ô∏è  [C003] WARNING: CLUSTER Encrypted passwords with MD5. 1 : 
password_encryption is md5 

NOTICE:  ‚ùå [S001] ERROR: No default role grantee on schema 5.5. It means that each time a table is created, you must grant it to roles. Object list:
dev_reports
prod_analytics
public
staging_data
tests

NOTICE:  ‚ùå [S002] ERROR: 3/5 schemas are prefixed or suffixed with environment names. It exceed the error threshold: 60%. Prefer prefix or suffix the database name instead. Object list:
dev_reports
prod_analytics
staging_data

NOTICE:  ‚ö†Ô∏è  [S003] WARNING: 1/5 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 20%. Object list:
public

NOTICE:  ‚ö†Ô∏è  [S004] WARNING: 1/5 schemas are owned by internal roles or superuser. Exceed the warning threshold: 20%. Object list:
mac-Z50PPETI is the owner of the schema dev_reports
mac-Z50PPETI is the owner of the schema prod_analytics
mac-Z50PPETI is the owner of the schema public
mac-Z50PPETI is the owner of the schema staging_data
mac-Z50PPETI is the owner of the schema tests

NOTICE:  ==================================================
NOTICE:  üìä Summary: 5 error(s), 6 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

-- Re-enable rules
SELECT pglinter.enable_rule('B001');
NOTICE:  ‚úÖ Rule B001 has been enabled
 enable_rule 
-------------
 t
(1 row)

-- Final comprehensive check
SELECT pglinter.check();
NOTICE:  üîç pglinter found 12 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/7 table(s) without primary key exceed the warning threshold: 14%. Object list:
public.users_no_pk

NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 4/10 redundant(s) index exceed the warning threshold: 40%. Object list:
public.products.idx_name_1(name) is redundant with idx_name_2(name)
public.products.idx_name_2(name) is redundant with idx_name_1(name)
public.products.idx_composite_1(category,price) is redundant with idx_composite_2(category,price)
public.products.idx_composite_2(category,price) is redundant with idx_composite_1(category,price)

NOTICE:  ‚ùå [B003] ERROR: 1/1 table(s) without index on foreign key exceed the error threshold: 100%. Object list:
public.orders.fk_product

NOTICE:  ‚ùå [B004] ERROR: 4/4 unused index exceed the error threshold: 100%. Object list:
dev_reports.summarieshas100 % of seq scan.
prod_analytics.metricshas100 % of seq scan.
public.UPPERCASE_ISSUEShas100 % of seq scan.
public.itemshas100 % of seq scan.
public.ordershas100 % of seq scan.
public.productshas100 % of seq scan.
public.users_no_pkhas100 % of seq scan.

NOTICE:  ‚ö†Ô∏è  [B010] WARNING: 2/7 object(s) using reserved keywords exceed the warning threshold: 28%. Object list:
column in public.items.FROM is a reserved keyword: FROM
column in public.items.SELECT is a reserved keyword: SELECT

NOTICE:  ‚ö†Ô∏è  [C001] WARNING: CLUSTER {0} entries in pg_hba.conf with trust authentication method exceed the warning threshold: {1}. 1 : 
Row 1 

NOTICE:  ‚ùå [C002] ERROR: 6 entries in pg_hba.conf with trust or password authentication method exceed the warning threshold: 6.
NOTICE:  ‚ö†Ô∏è  [C003] WARNING: CLUSTER Encrypted passwords with MD5. 1 : 
password_encryption is md5 

NOTICE:  ‚ùå [S001] ERROR: No default role grantee on schema 5.5. It means that each time a table is created, you must grant it to roles. Object list:
dev_reports
prod_analytics
public
staging_data
tests

NOTICE:  ‚ùå [S002] ERROR: 3/5 schemas are prefixed or suffixed with environment names. It exceed the error threshold: 60%. Prefer prefix or suffix the database name instead. Object list:
dev_reports
prod_analytics
staging_data

NOTICE:  ‚ö†Ô∏è  [S003] WARNING: 1/5 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 20%. Object list:
public

NOTICE:  ‚ö†Ô∏è  [S004] WARNING: 1/5 schemas are owned by internal roles or superuser. Exceed the warning threshold: 20%. Object list:
mac-Z50PPETI is the owner of the schema dev_reports
mac-Z50PPETI is the owner of the schema prod_analytics
mac-Z50PPETI is the owner of the schema public
mac-Z50PPETI is the owner of the schema staging_data
mac-Z50PPETI is the owner of the schema tests

NOTICE:  ==================================================
NOTICE:  üìä Summary: 5 error(s), 7 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

-- Clean up
DROP SCHEMA prod_analytics CASCADE;
NOTICE:  drop cascades to table prod_analytics.metrics
DROP SCHEMA dev_reports CASCADE;
NOTICE:  drop cascades to table dev_reports.summaries
DROP SCHEMA staging_data CASCADE;
DROP TABLE items CASCADE;
DROP TABLE "UPPERCASE_ISSUES" CASCADE;
DROP TABLE orders CASCADE;
DROP TABLE products CASCADE;
DROP TABLE users_no_pk CASCADE;
DROP EXTENSION pglinter CASCADE;

DROP EXTENSION IF EXISTS pglinter CASCADE;
NOTICE:  extension "pglinter" does not exist, skipping
-- Create test data that will trigger multiple rules
CREATE TABLE table_without_pk (
    id INT,
    name TEXT
);
-- Create redundant indexes
CREATE INDEX idx_name_1 ON table_without_pk (name);
CREATE INDEX idx_name_2 ON table_without_pk (name);
-- Create table with uppercase (triggers B006 and T011)
CREATE TABLE "UPPERCASE_TABLE" (
    id SERIAL PRIMARY KEY,
    "UPPER_COLUMN" TEXT
);
-- Create schema with environment prefix (triggers S002)
CREATE SCHEMA prod_testing;
CREATE EXTENSION IF NOT EXISTS pglinter;
-- Test 1: Output to prompt (no file parameter)
SELECT 'Testing output to prompt...' AS test_info;
          test_info          
-----------------------------
 Testing output to prompt...
(1 row)

SELECT pglinter.perform_base_check();
NOTICE:  üîç pglinter found 5 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/2 table(s) without primary key exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 2/3 redundant(s) index exceed the warning threshold: 66%.
NOTICE:  ‚ùå [B004] ERROR: 2/2 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/2 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B006] WARNING: 4/13 object(s) using uppercase for name or columns exceed the warning threshold: 30%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 4 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check 
--------------------
 t
(1 row)

SELECT pglinter.perform_table_check();
NOTICE:  üîç pglinter found 3 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [T001] WARNING: TABLE no primary key on table(s) 1 : 
public.table_without_pk 

NOTICE:  ‚ö†Ô∏è  [T002] WARNING: TABLE duplicated index 2 : 
public.table_without_pk idx idx_name_1 columns (name) is a subset of idx idx_name_2 columns (name)
public.table_without_pk idx idx_name_2 columns (name) is a subset of idx idx_name_1 columns (name) 

NOTICE:  ‚ö†Ô∏è  [T004] WARNING: TABLE table with potential missing index 2 : 
public.table_without_pk:100 % of seq scan
public.UPPERCASE_TABLE:100 % of seq scan 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 3 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 perform_table_check 
---------------------
 t
(1 row)

SELECT pglinter.perform_schema_check();
NOTICE:  üîç pglinter found 2 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [S001] WARNING: SCHEMA No default role grantee on schema {0}.{1}. It means that each time a table is created, you must grant it to roles. 1 : 
prod_testing 

NOTICE:  ‚ö†Ô∏è  [S002] WARNING: SCHEMA You should not prefix or suffix the schema name with {0}. You may have difficulties when refreshing environments. Prefer prefix or suffix the database name. 1 : 
prod_testing 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 2 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 perform_schema_check 
----------------------
 t
(1 row)

-- Test 2: Output to prompt (NULL file parameter)
SELECT 'Testing output to prompt with NULL...' AS test_info;
               test_info               
---------------------------------------
 Testing output to prompt with NULL...
(1 row)

SELECT pglinter.perform_base_check(NULL);
NOTICE:  üîç pglinter found 5 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/2 table(s) without primary key exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 2/3 redundant(s) index exceed the warning threshold: 66%.
NOTICE:  ‚ùå [B004] ERROR: 2/2 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/2 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B006] WARNING: 4/13 object(s) using uppercase for name or columns exceed the warning threshold: 30%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 4 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check 
--------------------
 t
(1 row)

SELECT pglinter.perform_table_check(NULL);
NOTICE:  üîç pglinter found 3 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [T001] WARNING: TABLE no primary key on table(s) 1 : 
public.table_without_pk 

NOTICE:  ‚ö†Ô∏è  [T002] WARNING: TABLE duplicated index 2 : 
public.table_without_pk idx idx_name_1 columns (name) is a subset of idx idx_name_2 columns (name)
public.table_without_pk idx idx_name_2 columns (name) is a subset of idx idx_name_1 columns (name) 

NOTICE:  ‚ö†Ô∏è  [T004] WARNING: TABLE table with potential missing index 2 : 
public.table_without_pk:100 % of seq scan
public.UPPERCASE_TABLE:100 % of seq scan 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 3 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 perform_table_check 
---------------------
 t
(1 row)

SELECT pglinter.perform_schema_check(NULL);
NOTICE:  üîç pglinter found 2 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [S001] WARNING: SCHEMA No default role grantee on schema {0}.{1}. It means that each time a table is created, you must grant it to roles. 1 : 
prod_testing 

NOTICE:  ‚ö†Ô∏è  [S002] WARNING: SCHEMA You should not prefix or suffix the schema name with {0}. You may have difficulties when refreshing environments. Prefer prefix or suffix the database name. 1 : 
prod_testing 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 2 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 perform_schema_check 
----------------------
 t
(1 row)

-- Test 3: Output to file
SELECT 'Testing output to file...' AS test_info;
         test_info         
---------------------------
 Testing output to file...
(1 row)

SELECT pglinter.perform_base_check('/tmp/test_base_output.sarif');
 perform_base_check 
--------------------
 t
(1 row)

SELECT pglinter.perform_table_check('/tmp/test_table_output.sarif');
 perform_table_check 
---------------------
 t
(1 row)

SELECT pglinter.perform_schema_check('/tmp/test_schema_output.sarif');
 perform_schema_check 
----------------------
 t
(1 row)

-- Test 4: Comprehensive check with different output options
SELECT 'Testing comprehensive check - to prompt...' AS test_info;
                 test_info                  
--------------------------------------------
 Testing comprehensive check - to prompt...
(1 row)

SELECT pglinter.check_all();
NOTICE:  üîç Running comprehensive pglinter check...
NOTICE:  
NOTICE:  üìã BASE CHECKS:
NOTICE:  üîç pglinter found 5 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/2 table(s) without primary key exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 2/3 redundant(s) index exceed the warning threshold: 66%.
NOTICE:  ‚ùå [B004] ERROR: 2/2 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/2 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B006] WARNING: 4/13 object(s) using uppercase for name or columns exceed the warning threshold: 30%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 4 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
NOTICE:  
NOTICE:  üñ•Ô∏è  CLUSTER CHECKS:
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ùå [C002] ERROR: 6 entries in pg_hba.conf with trust or password authentication method exceed the warning threshold: 6.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 0 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
NOTICE:  
NOTICE:  üìä TABLE CHECKS:
NOTICE:  üîç pglinter found 3 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [T001] WARNING: TABLE no primary key on table(s) 1 : 
public.table_without_pk 

NOTICE:  ‚ö†Ô∏è  [T002] WARNING: TABLE duplicated index 2 : 
public.table_without_pk idx idx_name_1 columns (name) is a subset of idx idx_name_2 columns (name)
public.table_without_pk idx idx_name_2 columns (name) is a subset of idx idx_name_1 columns (name) 

NOTICE:  ‚ö†Ô∏è  [T004] WARNING: TABLE table with potential missing index 2 : 
public.table_without_pk:100 % of seq scan
public.UPPERCASE_TABLE:100 % of seq scan 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 3 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
NOTICE:  
NOTICE:  üóÇÔ∏è  SCHEMA CHECKS:
NOTICE:  üîç pglinter found 2 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [S001] WARNING: SCHEMA No default role grantee on schema {0}.{1}. It means that each time a table is created, you must grant it to roles. 1 : 
prod_testing 

NOTICE:  ‚ö†Ô∏è  [S002] WARNING: SCHEMA You should not prefix or suffix the schema name with {0}. You may have difficulties when refreshing environments. Prefer prefix or suffix the database name. 1 : 
prod_testing 

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 2 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
NOTICE:  
NOTICE:  üéâ All pglinter checks completed successfully!
 check_all 
-----------
 t
(1 row)

-- Test 5: Individual rule testing
SELECT pglinter.explain_rule('B001');
NOTICE:  üìñ Rule Explanation for B001
============================================================

üéØ Rule Name: HowManyTableWithoutPrimaryKey
üìã Scope: BASE

üìù Description:
Count number of tables without primary key.

‚ö†Ô∏è  Message Template:
{0}/{1} table(s) without primary key exceed the {2} threshold: {3}%.

üîß How to Fix:
   1. create a primary key or change warning/error threshold
============================================================
 explain_rule 
--------------
 t
(1 row)

SELECT pglinter.explain_rule('T003');
NOTICE:  üìñ Rule Explanation for T003
============================================================

üéØ Rule Name: TableWithFkNotIndexed
üìã Scope: TABLE

üìù Description:
When you delete or update a row in the parent table, the database must check the child table to ensure there are no orphaned records. An index on the foreign key allows for a rapid lookup, ensuring that these checks don't negatively impact performance.

‚ö†Ô∏è  Message Template:
unindexed constraint

üîß How to Fix:
   1. create an index on the child table fk.
============================================================
 explain_rule 
--------------
 t
(1 row)

SELECT pglinter.explain_rule('S002');
NOTICE:  üìñ Rule Explanation for S002
============================================================

üéØ Rule Name: SchemaPrefixedOrSuffixedWithEnvt
üìã Scope: SCHEMA

üìù Description:
The schema is prefixed with one of staging,stg,preprod,prod,sandbox,sbox string. Means that when you refresh your preprod, staging environments from production, you have to rename the target schema from prod_ to stg_ or something like. It is possible, but it is never easy.

‚ö†Ô∏è  Message Template:
You should not prefix or suffix the schema name with {0}. You may have difficulties when refreshing environments. Prefer prefix or suffix the database name.

üîß How to Fix:
   1. Keep the same schema name across environments. Prefer prefix or suffix the database name
============================================================
 explain_rule 
--------------
 t
(1 row)

-- Test 6: Rule management
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  B006   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B007   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  T001   ‚úÖ ON     TableWithoutPrimaryKey                  
NOTICE:  T002   ‚úÖ ON     TableWithRedundantIndex                 
NOTICE:  T003   ‚úÖ ON     TableWithFkNotIndexed                   
NOTICE:  T004   ‚úÖ ON     TableWithPotentialMissingIdx            
NOTICE:  T005   ‚úÖ ON     TableWithFkOutsideSchema                
NOTICE:  T006   ‚úÖ ON     TableWithUnusedIndex                    
NOTICE:  T007   ‚úÖ ON     TableWithFkMismatch                     
NOTICE:  T008   ‚úÖ ON     TableWithRoleNotGranted                 
NOTICE:  T009   ‚úÖ ON     ReservedKeyWord                         
NOTICE:  T010   üî¥ OFF    TableWithSensibleColumn                 
NOTICE:  ============================================================
NOTICE:  üìä Summary: 20 enabled, 1 disabled
 show_rules 
------------
 t
(1 row)

-- Test 7: Rule enable/disable functionality
SELECT pglinter.disable_rule('B006');
NOTICE:  üî¥ Rule B006 has been disabled
 disable_rule 
--------------
 t
(1 row)

SELECT pglinter.perform_base_check(); -- Should skip B006
NOTICE:  üîç pglinter found 4 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/2 table(s) without primary key exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 2/3 redundant(s) index exceed the warning threshold: 66%.
NOTICE:  ‚ùå [B004] ERROR: 2/2 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/2 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 50%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 3 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check 
--------------------
 t
(1 row)

SELECT pglinter.enable_rule('B006');
NOTICE:  ‚úÖ Rule B006 has been enabled
 enable_rule 
-------------
 t
(1 row)

SELECT pglinter.perform_base_check(); -- Should include B006 again
NOTICE:  üîç pglinter found 5 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B001] WARNING: 1/2 table(s) without primary key exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 2/3 redundant(s) index exceed the warning threshold: 66%.
NOTICE:  ‚ùå [B004] ERROR: 2/2 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/2 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 50%.
NOTICE:  ‚ö†Ô∏è  [B006] WARNING: 4/13 object(s) using uppercase for name or columns exceed the warning threshold: 30%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 4 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check 
--------------------
 t
(1 row)

-- Clean up
DROP SCHEMA prod_testing CASCADE;
DROP TABLE "UPPERCASE_TABLE" CASCADE;
DROP TABLE table_without_pk CASCADE;

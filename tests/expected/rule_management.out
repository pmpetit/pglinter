-- Test for pglinter rule management functionality
CREATE EXTENSION pglinter;
CREATE TABLE test_table_for_rules (
    id INT,
    name TEXT
);
-- Show initial rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B006   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B007   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkMismatch             
NOTICE:  B009   ‚úÖ ON     HowManyTablesWithSameTrigger            
NOTICE:  B010   ‚úÖ ON     HowManyTablesWithReservedKeywords       
NOTICE:  B011   ‚úÖ ON     SeveralTableOwnerInSchema               
NOTICE:  C001   ‚úÖ ON     PgHbaEntriesWithMethodTrustShouldNotExists
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  C003   ‚úÖ ON     PasswordEncryptionIsMd5                 
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  S003   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  S004   ‚úÖ ON     OwnerSchemaIsInternalRole               
NOTICE:  S005   ‚úÖ ON     SchemaOwnerDoNotMatchTableOwner         
NOTICE:  ============================================================
NOTICE:  üìä Summary: 19 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

-- Test enabling and disabling a specific rule
SELECT pglinter.is_rule_enabled('B001') AS b001_initially_enabled;
 b001_initially_enabled 
------------------------
 t
(1 row)

-- Disable B001 rule
SELECT pglinter.disable_rule('B001') AS b001_disabled;
NOTICE:  üî¥ Rule B001 has been disabled
 b001_disabled 
---------------
 t
(1 row)

-- Check if it's disabled
SELECT pglinter.is_rule_enabled('B001') AS b001_after_disable;
 b001_after_disable 
--------------------
 f
(1 row)

-- Run base check (should skip B001)
SELECT pglinter.check();
NOTICE:  üîç pglinter found 6 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [C001] WARNING: CLUSTER {0} entries in pg_hba.conf with trust authentication method exceed the warning threshold: {1}. 1 : 
Row 1 

NOTICE:  ‚ùå [C002] ERROR: 6 entries in pg_hba.conf with trust or password authentication method exceed the warning threshold: 6.
NOTICE:  ‚ö†Ô∏è  [C003] WARNING: CLUSTER Encrypted passwords with MD5. 1 : 
password_encryption is md5 

NOTICE:  ‚ùå [S001] ERROR: No default role grantee on schema 1.1. It means that each time a table is created, you must grant it to roles. Object list:
public

NOTICE:  ‚ùå [S003] ERROR: 1/1 schemas are unsecured, schemas where all users can create objects in, exceed the error threshold: 100%. Object list:
public

NOTICE:  ‚ùå [S004] ERROR: 1/1 schemas are owned by internal roles or superuser. Exceed the error threshold: 100%. Object list:
mac-Z50PPETI is the owner of the schema public

NOTICE:  ==================================================
NOTICE:  üìä Summary: 4 error(s), 2 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

-- Re-enable B001 rule
SELECT pglinter.enable_rule('B001') AS b001_enabled;
NOTICE:  ‚úÖ Rule B001 has been enabled
 b001_enabled 
--------------
 t
(1 row)

-- Check if it's enabled again
SELECT pglinter.is_rule_enabled('B001') AS b001_after_enable;
 b001_after_enable 
-------------------
 t
(1 row)

-- Test with non-existent rule
SELECT pglinter.disable_rule('NONEXISTENT') AS nonexistent_disable;
WARNING:  ‚ö†Ô∏è  Rule NONEXISTENT not found
 nonexistent_disable 
---------------------
 f
(1 row)

-- Show final rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B006   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B007   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkMismatch             
NOTICE:  B009   ‚úÖ ON     HowManyTablesWithSameTrigger            
NOTICE:  B010   ‚úÖ ON     HowManyTablesWithReservedKeywords       
NOTICE:  B011   ‚úÖ ON     SeveralTableOwnerInSchema               
NOTICE:  C001   ‚úÖ ON     PgHbaEntriesWithMethodTrustShouldNotExists
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  C003   ‚úÖ ON     PasswordEncryptionIsMd5                 
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  S003   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  S004   ‚úÖ ON     OwnerSchemaIsInternalRole               
NOTICE:  S005   ‚úÖ ON     SchemaOwnerDoNotMatchTableOwner         
NOTICE:  ============================================================
NOTICE:  üìä Summary: 19 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

DROP TABLE test_table_for_rules CASCADE;
DROP EXTENSION pglinter CASCADE;

-- Test for pglinter rule management functionality
CREATE EXTENSION pglinter;
CREATE TABLE test_table_for_rules (
    id INT,
    name TEXT
);
-- Show initial rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B006   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B007   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkMismatch             
NOTICE:  B009   ‚úÖ ON     HowManyTablesWithSameTrigger            
NOTICE:  B010   ‚úÖ ON     HowManyTablesWithReservedKeywords       
NOTICE:  B011   ‚úÖ ON     SeveralTableOwnerInSchema               
NOTICE:  C001   ‚úÖ ON     PgHbaEntriesWithMethodTrustShouldNotExists
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  C003   ‚úÖ ON     PasswordEncryptionIsMd5                 
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  S003   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  S004   ‚úÖ ON     OwnerSchemaIsInternalRole               
NOTICE:  S005   ‚úÖ ON     SchemaOwnerDoNotMatchTableOwner         
NOTICE:  ============================================================
NOTICE:  üìä Summary: 19 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

-- Test enabling and disabling a specific rule
SELECT pglinter.is_rule_enabled('B001') AS b001_initially_enabled;
 b001_initially_enabled 
------------------------
 t
(1 row)

-- Disable B001 rule
SELECT pglinter.disable_rule('B001') AS b001_disabled;
NOTICE:  üî¥ Rule B001 has been disabled
 b001_disabled 
---------------
 t
(1 row)

-- Check if it's disabled
SELECT pglinter.is_rule_enabled('B001') AS b001_after_disable;
 b001_after_disable 
--------------------
 f
(1 row)

-- Run base check (should skip B001)
SELECT pglinter.perform_base_check();
WARNING:  pglinter base check failed: Failed to execute q2 rule B011: Database error: SpiTupleTable positioned before the start or after the end
 perform_base_check 
--------------------
 f
(1 row)

-- Re-enable B001 rule
SELECT pglinter.enable_rule('B001') AS b001_enabled;
NOTICE:  ‚úÖ Rule B001 has been enabled
 b001_enabled 
--------------
 t
(1 row)

-- Check if it's enabled again
SELECT pglinter.is_rule_enabled('B001') AS b001_after_enable;
 b001_after_enable 
-------------------
 t
(1 row)

-- Test with non-existent rule
SELECT pglinter.disable_rule('NONEXISTENT') AS nonexistent_disable;
WARNING:  ‚ö†Ô∏è  Rule NONEXISTENT not found
 nonexistent_disable 
---------------------
 f
(1 row)

-- Show final rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B006   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B007   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkMismatch             
NOTICE:  B009   ‚úÖ ON     HowManyTablesWithSameTrigger            
NOTICE:  B010   ‚úÖ ON     HowManyTablesWithReservedKeywords       
NOTICE:  B011   ‚úÖ ON     SeveralTableOwnerInSchema               
NOTICE:  C001   ‚úÖ ON     PgHbaEntriesWithMethodTrustShouldNotExists
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  C003   ‚úÖ ON     PasswordEncryptionIsMd5                 
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  S003   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  S004   ‚úÖ ON     OwnerSchemaIsInternalRole               
NOTICE:  S005   ‚úÖ ON     SchemaOwnerDoNotMatchTableOwner         
NOTICE:  ============================================================
NOTICE:  üìä Summary: 19 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

DROP TABLE test_table_for_rules CASCADE;
DROP EXTENSION pglinter CASCADE;

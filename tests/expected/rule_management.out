-- Test for pglinter rule management functionality
BEGIN;
DROP EXTENSION IF EXISTS pglinter CASCADE;
CREATE TABLE IF NOT EXISTS test_table_for_rules (
    id INT,
    name TEXT
);
CREATE EXTENSION IF NOT EXISTS pglinter;
-- Show initial rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  B006   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B007   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  T001   ‚úÖ ON     TableWithoutPrimaryKey                  
NOTICE:  T002   ‚úÖ ON     TableWithRedundantIndex                 
NOTICE:  T003   ‚úÖ ON     TableWithFkNotIndexed                   
NOTICE:  T004   ‚úÖ ON     TableWithPotentialMissingIdx            
NOTICE:  T005   ‚úÖ ON     TableWithFkOutsideSchema                
NOTICE:  T006   ‚úÖ ON     TableWithUnusedIndex                    
NOTICE:  T007   ‚úÖ ON     TableWithFkMismatch                     
NOTICE:  T008   ‚úÖ ON     TableWithRoleNotGranted                 
NOTICE:  T009   ‚úÖ ON     ReservedKeyWord                         
NOTICE:  T010   ‚úÖ ON     TableWithSensibleColumn                 
NOTICE:  ============================================================
NOTICE:  üìä Summary: 21 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

-- Test enabling and disabling a specific rule
SELECT pglinter.is_rule_enabled('B001') AS b001_initially_enabled;
 b001_initially_enabled 
------------------------
 t
(1 row)

-- Disable B001 rule
SELECT pglinter.disable_rule('B001') AS b001_disabled;
NOTICE:  üî¥ Rule B001 has been disabled
 b001_disabled 
---------------
 t
(1 row)

-- Check if it's disabled
SELECT pglinter.is_rule_enabled('B001') AS b001_after_disable;
 b001_after_disable 
--------------------
 f
(1 row)

-- Run base check (should skip B001)
SELECT pglinter.perform_base_check();
NOTICE:  üîç pglinter found 4 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [B002] WARNING: 4/15 redundant(s) index exceed the warning threshold: 26%.
NOTICE:  ‚ùå [B004] ERROR: 5/5 unused index exceed the error threshold: 100%
NOTICE:  ‚ö†Ô∏è  [B005] WARNING: 1/3 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 33%.
NOTICE:  ‚ö†Ô∏è  [B006] WARNING: 34/105 object(s) using uppercase for name or columns exceed the warning threshold: 32%.
NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 3 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 perform_base_check 
--------------------
 t
(1 row)

-- Re-enable B001 rule
SELECT pglinter.enable_rule('B001') AS b001_enabled;
NOTICE:  ‚úÖ Rule B001 has been enabled
 b001_enabled 
--------------
 t
(1 row)

-- Check if it's enabled again
SELECT pglinter.is_rule_enabled('B001') AS b001_after_enable;
 b001_after_enable 
-------------------
 t
(1 row)

-- Test with non-existent rule
SELECT pglinter.disable_rule('NONEXISTENT') AS nonexistent_disable;
WARNING:  ‚ö†Ô∏è  Rule NONEXISTENT not found
 nonexistent_disable 
---------------------
 f
(1 row)

-- Show final rule status
SELECT pglinter.show_rules();
NOTICE:  üìã pglinter Rule Status:
NOTICE:  ============================================================
NOTICE:  Code   Status   Name                                    
NOTICE:  ------------------------------------------------------------
NOTICE:  B001   ‚úÖ ON     HowManyTableWithoutPrimaryKey           
NOTICE:  B002   ‚úÖ ON     HowManyRedudantIndex                    
NOTICE:  B003   ‚úÖ ON     HowManyTableWithoutIndexOnFk            
NOTICE:  B004   ‚úÖ ON     HowManyUnusedIndex                      
NOTICE:  B005   ‚úÖ ON     UnsecuredPublicSchema                   
NOTICE:  B006   ‚úÖ ON     HowManyObjectsWithUppercase             
NOTICE:  B007   ‚úÖ ON     HowManyTablesNeverSelected              
NOTICE:  B008   ‚úÖ ON     HowManyTablesWithFkOutsideSchema        
NOTICE:  C002   ‚úÖ ON     PgHbaEntriesWithMethodTrustOrPasswordShouldNotExists
NOTICE:  S001   ‚úÖ ON     SchemaWithDefaultRoleNotGranted         
NOTICE:  S002   ‚úÖ ON     SchemaPrefixedOrSuffixedWithEnvt        
NOTICE:  T001   ‚úÖ ON     TableWithoutPrimaryKey                  
NOTICE:  T002   ‚úÖ ON     TableWithRedundantIndex                 
NOTICE:  T003   ‚úÖ ON     TableWithFkNotIndexed                   
NOTICE:  T004   ‚úÖ ON     TableWithPotentialMissingIdx            
NOTICE:  T005   ‚úÖ ON     TableWithFkOutsideSchema                
NOTICE:  T006   ‚úÖ ON     TableWithUnusedIndex                    
NOTICE:  T007   ‚úÖ ON     TableWithFkMismatch                     
NOTICE:  T008   ‚úÖ ON     TableWithRoleNotGranted                 
NOTICE:  T009   ‚úÖ ON     ReservedKeyWord                         
NOTICE:  T010   ‚úÖ ON     TableWithSensibleColumn                 
NOTICE:  ============================================================
NOTICE:  üìä Summary: 21 enabled, 0 disabled
 show_rules 
------------
 t
(1 row)

ROLLBACK;

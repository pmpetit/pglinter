-- Regression test for S002: SchemaPrefixedOrSuffixedWithEnvt
-- This test creates schemas with environment prefixes/suffixes and checks that S002 identifies them.
CREATE EXTENSION IF NOT EXISTS pglinter;
-- Setup: Create test role
CREATE ROLE s002_owner LOGIN;
-- Create schemas with environment prefixes/suffixes
CREATE SCHEMA prod_schema AUTHORIZATION s002_owner;
CREATE SCHEMA dev_schema AUTHORIZATION s002_owner;
CREATE SCHEMA s002_schema AUTHORIZATION s002_owner;
SELECT 'Testing S002 in isolation...' AS test_step;
          test_step           
------------------------------
 Testing S002 in isolation...
(1 row)

SELECT pglinter.disable_all_rules() AS all_disabled;
NOTICE:  üî¥ Disabled 20 rule(s)
 all_disabled 
--------------
           20
(1 row)

SELECT pglinter.enable_rule('S002') AS S002_only_enabled;
NOTICE:  ‚úÖ Rule S002 has been enabled
 s002_only_enabled 
-------------------
 t
(1 row)

SELECT pglinter.check(); -- Should only run S002
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ùå [S002] ERROR: 2/4 schemas are prefixed or suffixed with environment names. It exceed the error threshold: 50%. Prefer prefix or suffix the database name instead. Object list:
dev_schema
prod_schema

NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 0 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'S002';
 violation_count 
-----------------
               2
(1 row)

-- Cleanup
DROP SCHEMA prod_schema CASCADE;
DROP SCHEMA dev_schema CASCADE;
DROP SCHEMA s002_schema CASCADE;
DROP ROLE s002_owner;
DROP EXTENSION pglinter CASCADE;

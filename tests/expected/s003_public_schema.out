-- Regression test for S003 rule: Schemas with public CREATE privileges
-- Tests the percentage-based detection of schemas allowing CREATE for public role
-- versus total schemas in the database
CREATE EXTENSION pglinter;
SELECT 'S003 Regression Test: Schemas with public CREATE privileges' AS test_header;
                         test_header                         
-------------------------------------------------------------
 S003 Regression Test: Schemas with public CREATE privileges
(1 row)

-- Setup S003 rule for testing
SELECT pglinter.disable_all_rules();
NOTICE:  üî¥ Disabled 20 rule(s)
 disable_all_rules 
-------------------
                20
(1 row)

SELECT pglinter.enable_rule('S003');
NOTICE:  ‚úÖ Rule S003 has been enabled
 enable_rule 
-------------
 t
(1 row)

-- PART 1: Test with LOW percentage of insecure schemas (should NOT trigger)
SELECT 'PART 1: Testing with LOW percentage of insecure schemas (should NOT trigger)' AS test_part;
                                  test_part                                   
------------------------------------------------------------------------------
 PART 1: Testing with LOW percentage of insecure schemas (should NOT trigger)
(1 row)

-- Create one secure schema (no public CREATE)
CREATE SCHEMA test_secure_schema;
REVOKE CREATE ON SCHEMA test_secure_schema FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_1;
REVOKE CREATE ON SCHEMA test_secure_schema_1 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_2;
REVOKE CREATE ON SCHEMA test_secure_schema_2 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_3;
REVOKE CREATE ON SCHEMA test_secure_schema_3 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_4;
REVOKE CREATE ON SCHEMA test_secure_schema_4 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_5;
REVOKE CREATE ON SCHEMA test_secure_schema_5 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_6;
REVOKE CREATE ON SCHEMA test_secure_schema_6 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_7;
REVOKE CREATE ON SCHEMA test_secure_schema_7 FROM public;
-- Create one secure schema
CREATE SCHEMA test_secure_schema_8;
REVOKE CREATE ON SCHEMA test_secure_schema_8 FROM public;
-- Create one insecure schema
CREATE SCHEMA test_insecure_schema_1;
GRANT CREATE ON SCHEMA test_insecure_schema_1 TO public;
-- Test S003 with low percentage (should not trigger with default thresholds)
SELECT 'Running S003 check with LOW percentage of insecure schemas (should not trigger with default thresholds):' AS test_1;
                                                  test_1                                                  
----------------------------------------------------------------------------------------------------------
 Running S003 check with LOW percentage of insecure schemas (should not trigger with default thresholds):
(1 row)

SELECT pglinter.check();
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [S003] WARNING: 2/11 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 18%. Object list:
public
test_insecure_schema_1

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'S003';
 violation_count 
-----------------
               2
(1 row)

CREATE SCHEMA test_insecure_schema_2;
GRANT CREATE ON SCHEMA test_insecure_schema_2 TO public;
-- Test S003 with high percentage (should trigger)
SELECT 'Running S003 check with HIGH percentage of insecure schemas (should trigger):' AS test_2;
                                    test_2                                     
-------------------------------------------------------------------------------
 Running S003 check with HIGH percentage of insecure schemas (should trigger):
(1 row)

SELECT pglinter.check();
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ö†Ô∏è  [S003] WARNING: 3/12 schemas are unsecured, schemas where all users can create objects in, exceed the warning threshold: 25%. Object list:
public
test_insecure_schema_1
test_insecure_schema_2

NOTICE:  ==================================================
NOTICE:  üìä Summary: 0 error(s), 1 warning(s), 0 info
NOTICE:  üü° Some warnings found - consider reviewing for optimization
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'S003';
 violation_count 
-----------------
               3
(1 row)

-- Test with file output
SELECT pglinter.check('/tmp/pglinter_s003_results.sarif');
 check 
-------
 t
(1 row)

-- Test if file exists and show checksum
\! md5sum /tmp/pglinter_s003_results.sarif
08a2adceab19498eadf8b707623c140d  /tmp/pglinter_s003_results.sarif
-- PART 3: Test threshold adjustment
SELECT 'PART 3: Testing S003 threshold adjustments (should not trigger)' AS test_part;
                            test_part                            
-----------------------------------------------------------------
 PART 3: Testing S003 threshold adjustments (should not trigger)
(1 row)

-- Lower the warning threshold to ensure detection
SELECT pglinter.update_rule_levels('S003', 50, 80);
NOTICE:  ‚úÖ Updated rule S003 levels: warning=50, error=80
 update_rule_levels 
--------------------
 t
(1 row)

SELECT 'S003 thresholds updated to warning=50%, error=80%' AS threshold_info;
                  threshold_info                   
---------------------------------------------------
 S003 thresholds updated to warning=50%, error=80%
(1 row)

-- Test with adjusted thresholds
SELECT 'Running S003 check with adjusted thresholds (warning=50%):' AS test_3;
                           test_3                           
------------------------------------------------------------
 Running S003 check with adjusted thresholds (warning=50%):
(1 row)

SELECT pglinter.check();
NOTICE:  ‚úÖ No issues found - database schema looks good!
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'S003';
 violation_count 
-----------------
               3
(1 row)

-- PART 6: Verification of SQL queries used by S003
SELECT 'PART 6: Direct verification of S003 SQL queries' AS sql_verification;
                sql_verification                 
-------------------------------------------------
 PART 6: Direct verification of S003 SQL queries
(1 row)

-- Test rule explanation
SELECT 'S003 rule explanation:' AS rule_explanation;
    rule_explanation    
------------------------
 S003 rule explanation:
(1 row)

SELECT pglinter.explain_rule('S003');
NOTICE:  üìñ Rule Explanation for S003
============================================================

üéØ Rule Name: UnsecuredPublicSchema
üìã Scope: SCHEMA

üìù Description:
Only authorized users should be allowed to create objects.

‚ö†Ô∏è  Message Template:
{0}/{1} schemas are unsecured, schemas where all users can create objects in, exceed the {2} threshold: {3}%. Object list:\n{4}

üîß How to Fix:
   1. REVOKE CREATE ON SCHEMA <schema_name> FROM PUBLIC
============================================================
 explain_rule 
--------------
 t
(1 row)

DROP SCHEMA test_secure_schema CASCADE;
DROP SCHEMA test_secure_schema_1 CASCADE;
DROP SCHEMA test_secure_schema_2 CASCADE;
DROP SCHEMA test_secure_schema_3 CASCADE;
DROP SCHEMA test_secure_schema_4 CASCADE;
DROP SCHEMA test_secure_schema_5 CASCADE;
DROP SCHEMA test_secure_schema_6 CASCADE;
DROP SCHEMA test_secure_schema_7 CASCADE;
DROP SCHEMA test_secure_schema_8 CASCADE;
DROP SCHEMA test_insecure_schema_1 CASCADE;
DROP SCHEMA test_insecure_schema_2 CASCADE;
DROP EXTENSION pglinter CASCADE;

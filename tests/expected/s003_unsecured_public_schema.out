-- Regression test for S003: UnsecuredPublicSchema
-- This test creates a schema and grants CREATE privilege to PUBLIC, then checks that S003 identifies it.
CREATE EXTENSION IF NOT EXISTS pglinter;
\pset pager off
-- Setup: Create test role and schema
CREATE ROLE s003_owner LOGIN;
CREATE SCHEMA s003_schema AUTHORIZATION s003_owner;
-- Grant CREATE privilege to PUBLIC
GRANT CREATE ON SCHEMA s003_schema TO PUBLIC;
SELECT 'Testing S003 in isolation...' AS test_step;
          test_step           
------------------------------
 Testing S003 in isolation...
(1 row)

SELECT pglinter.disable_all_rules() AS all_disabled;
NOTICE:  üî¥ Disabled 20 rule(s)
 all_disabled 
--------------
           20
(1 row)

SELECT pglinter.enable_rule('S003') AS S003_only_enabled;
NOTICE:  ‚úÖ Rule S003 has been enabled
 s003_only_enabled 
-------------------
 t
(1 row)

SELECT pglinter.check(); -- Should only run S003
NOTICE:  üîç pglinter found 1 issue(s):
NOTICE:  ==================================================
NOTICE:  ‚ùå [S003] ERROR: 2/2 schemas are unsecured, schemas where all users can create objects in, exceed the error threshold: 100%. Object list:
public
s003_schema

NOTICE:  ==================================================
NOTICE:  üìä Summary: 1 error(s), 0 warning(s), 0 info
NOTICE:  üî¥ Critical issues found - please review and fix errors
 check 
-------
 t
(1 row)

SELECT count(*) AS violation_count from pglinter.get_violations() WHERE rule_code = 'S003';
 violation_count 
-----------------
               2
(1 row)

-- Cleanup
REVOKE CREATE ON SCHEMA s003_schema FROM PUBLIC;
DROP SCHEMA s003_schema CASCADE;
DROP ROLE s003_owner;
DROP EXTENSION pglinter CASCADE;

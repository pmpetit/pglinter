-- Regression test for S003: UnsecuredPublicSchema
-- This test creates a schema and grants CREATE privilege to PUBLIC, then checks that S003 identifies it.
CREATE EXTENSION IF NOT EXISTS pglinter;
NOTICE:  extension "pglinter" already exists, skipping
\pset pager off
-- Setup: Create test role and schema
CREATE ROLE s003_owner LOGIN;
CREATE SCHEMA s003_schema AUTHORIZATION s003_owner;
-- Grant CREATE privilege to PUBLIC
GRANT CREATE ON SCHEMA s003_schema TO PUBLIC;
SELECT 'Testing S003 in isolation...' AS test_step;
          test_step           
------------------------------
 Testing S003 in isolation...
(1 row)

SELECT pglinter.disable_all_rules() AS all_disabled;
NOTICE:  ðŸ”´ Disabled 1 rule(s)
 all_disabled 
--------------
            1
(1 row)

SELECT pglinter.enable_rule('S003') AS S003_only_enabled;
NOTICE:  âœ… Rule S003 has been enabled
 s003_only_enabled 
-------------------
 t
(1 row)

SELECT pglinter.perform_schema_check(); -- Should only run S003
ERROR:  function pglinter.perform_schema_check() does not exist
LINE 1: SELECT pglinter.perform_schema_check();
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
-- Cleanup
REVOKE CREATE ON SCHEMA s003_schema FROM PUBLIC;
DROP SCHEMA s003_schema CASCADE;
DROP ROLE s003_owner;
